#!/bin/bash
set -e

export PGPASSWORD=$POSTGRES_PASSWORD;

psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
    CREATE USER $APP_USER WITH PASSWORD '$APP_PASSWORD';

    CREATE DATABASE $APP_DATABASE_NAME WITH TEMPLATE template1;
    GRANT ALL PRIVILEGES ON DATABASE $APP_DATABASE_NAME TO $APP_USER;

    \connect $APP_DATABASE_NAME $APP_USER
    BEGIN;

    CREATE SCHEMA IF NOT EXISTS APP AUTHORIZATION $APP_USER;
    CREATE SCHEMA IF NOT EXISTS CONFIG AUTHORIZATION $APP_USER;
    CREATE SCHEMA IF NOT EXISTS TEMP AUTHORIZATION $APP_USER;

    CREATE TABLE IF NOT EXISTS TEMP.TEMP (
        id      CHAR(26) NOT NULL CHECK (CHAR_LENGTH(id) = 26) PRIMARY KEY,
        data    JSON     NOT NULL,
        version INT      NOT NULL,
        UNIQUE(id, version)
    );
    COMMIT;
EOSQL